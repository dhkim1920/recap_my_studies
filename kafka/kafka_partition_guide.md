
# Kafka 클러스터 파티션 수 결정 가이드

## 1. 파티션 수 증가의 장점
- **병렬 처리량 증가**: Kafka에서 파티션은 병렬 처리의 기본 단위이다. 프로듀서, 브로커, 컨슈머 모두 파티션 단위로 병렬 처리를 수행하므로, 파티션 수가 많을수록 처리량이 증가한다.
- **부하 분산 개선**: 여러 브로커에 파티션을 고르게 분산시켜 클러스터의 부하를 균등하게 분산할 수 있다.

## 2. 파티션 수 결정 기준
- **처리량 기반 공식**:
  ```
  최소 필요 파티션 수 = max(목표 처리량 ÷ 단일 파티션당 프로듀서 처리량, 목표 처리량 ÷ 단일 파티션당 컨슈머 처리량)
  ```
  단일 파티션당 프로듀서 및 컨슈머 처리량은 시스템 구성과 애플리케이션 로직에 따라 달라지므로 직접 측정해야 한다.

- **미래 확장 고려**: 키 기반 메시지를 사용하는 경우, 파티션 수 변경 시 메시지 순서 보장이 깨질 수 있다. 따라서 초기부터 미래 1~2년 뒤의 예상 처리량을 고려하여 충분한 파티션 수를 설정하는 것이 좋다.

## 3. 파티션 수 증가 시 주의사항

- **파일 핸들 수 증가**: 브로커는 각 파티션의 로그 세그먼트마다 파일 핸들을 열므로, 파티션 수가 많을수록 운영체제의 파일 핸들 수 제한을 충분히 늘려야 한다.
  (운영체제의 파일 핸들 수 제한(`ulimit -n`)을 최소 65,536 이상으로 설정)
- **메모리 사용량 증가**: 프로듀서와 컨슈머는 파티션별로 메시지를 버퍼링하므로, 파티션 수가 증가하면 메모리 요구량도 증가하게된다. 
  (파티션당 최소 수십 KB의 메모리를 확보하는 것이 권장)
- **장애 복구 지연**: 브로커 장애 시, 리더 파티션 수가 많으면 리더 재선출에 시간이 오래 걸려 서비스 중단 시간이 길어질 수 있다.
- **복제 지연 및 지연시간 증가**: 복제할 파티션 수가 많으면 커밋 지연이 발생해 end-to-end 지연 시간이 증가

## 4. 권장 파티션 수

- **브로커당 파티션 수**: 2,000개 ~ 4,000개 이하로 유지
- **클러스터 전체 파티션 수**: 수만 개 수준 (예: 20,000개 ~ 100,000개) 내에서 관리
- **End-to-End 지연을 줄이려면**:
  ```
  브로커당 파티션 수 ≤ 100 × 브로커 수 × 복제 계수
  ```

---

# 파티션 수 조정 예시

## 1. 가정
- 목표 처리량: 2,000MB/sec
- 단일 파티션당 프로듀서 처리량: 50MB/sec
- 단일 파티션당 컨슈머 처리량: 30MB/sec
- 복제 계수 (Replication Factor): 3
- 브로커 수: 10대

## 2. 1차 파티션 수 계산 (처리량 기준)
- 프로듀서 기준: 2000 ÷ 50 = 40개
- 컨슈머 기준: 2000 ÷ 30 ≈ 67개

**최소 필요 파티션 수 = 67개**

## 3. 브로커 수 고려 (파티션 분산)
- 파티션을 브로커에 고르게 분산해야 부하가 평등
- 브로커 수가 10대 → 파티션 수도 10의 배수로 설정 추천
- 67개는 10으로 나누어지지 않음 → 70개 또는 80개로 조정

## 4. 복제 계수 고려
- 복제 계수 3 → 각 파티션은 3개의 브로커에 복제
- 70개 파티션 × 3복제 = 210개 복제본
- 210개 복제본이 10개 브로커에 분산 → 브로커 1대당 약 21개 리더/팔로워 복제본

## 5. 최종 정리

| 항목 | 값 |
|:----|:---|
| 목표 처리량 | 2,000MB/sec |
| 단일 프로듀서 처리량 | 50MB/sec |
| 단일 컨슈머 처리량 | 30MB/sec |
| 복제 계수 | 3 |
| 브로커 수 | 10대 |
| 최종 추천 파티션 수 | 70개 |
 
> Kafka 파티션 수는 목표 처리량과 단일 파티션 성능을 기준으로 계산하고, 브로커 수의 배수에 맞춰 조정하여 부하를 고르게 분산하며, 복제 계수를 고려해 전체 복제본 수도 체크해야 한다.

## 기본 가정
- 단일 파티션당 처리량: 50MB/sec (프로듀서 기준)
- 복제 계수 (Replication Factor): 3
- 브로커당 권장 파티션 수: 2,000 ~ 4,000개 이하

## 목표 처리량별 표준 계산

| 목표 처리량 (MB/sec) | 1차 계산 파티션 수 | 최종 조정 파티션 수 (브로커 배수 고려) |
|:--------------------|:-------------------|:-------------------------------------|
| 500MB/sec | 10개 | 12~20개 추천 |
| 2,000MB/sec | 40개 | 70~80개 추천 |
| 5,000MB/sec | 100개 | 120~150개 추천 |
| 10,000MB/sec | 200개 | 240~300개 추천 |

> **주의**
> - 파티션 수는 최소 기준
> - 여유를 두고 1.2배~1.5배 정도 추가 설정 추천
> - 키 기반 메시지 처리 시 파티션 수 변경이 어려우므로 초기에 넉넉히 설정

---

# 초고속 스트리밍용 Kafka 파티션 설계법 (10Gbps 이상)

## 1. 환경 가정
- 초당 데이터 전송량: 10Gbps = 약 1,250MB/sec
- 단일 파티션당 프로듀서 처리량: 50MB/sec
- 브로커 수: 20대
- 복제 계수: 3

## 2. 기본 파티션 수 계산
- 1,250 ÷ 50 = 25개 (1Gbps 기준)
- 10Gbps → 10배 → 250개 파티션 필요

## 3. 브로커 분산 고려
- 250개 파티션을 20대 브로커에 분산
- 브로커당 약 12~13개 리더 파티션
- 복제본 포함 750개 복제본 → 브로커당 약 37~38개 복제본
- 문제 없음

## 4. 최종 설계 권장

| 항목 | 값 |
|:----|:---|
| 최종 파티션 수 | 300개 (브로커 수 고려 여유 포함) |
| 브로커당 평균 리더 수 | 15개 |
| 브로커당 평균 복제본 수 | 45개 |
| 설정 파일 `ulimit -n` (파일 핸들 수) | 최소 65536 이상 |
| End-to-End latency 최적화 | `num.replica.fetchers`, `socket.request.max.bytes` 조정 필요 |
 
> 10Gbps 이상 고속 Kafka 스트리밍을 설계할 때는, 초당 데이터량을 파티션당 처리량으로 나눈 뒤, 브로커 수의 배수로 맞추고, 복제 계수를 곱한 전체 복제본 수도 체크해서 리소스 한계 초과 여부를 반드시 확인해야 한다.

--- 

## 참고 문헌
- https://docs.cloudera.com/runtime/7.3.1/kafka-performance-tuning/topics/kafka-tune-sizing-partition-number.html
- https://www.confluent.io/blog/how-choose-number-topics-partitions-kafka-cluster/

## Amazon MSK Tiered Storage 개요 (한국어 번역 요약)

### 활성화
- `remote.storage.enable=true`

### 동작 방식

- 계층형 스토리지를 활성화하면, **Apache Kafka는 닫힌 로그 세그먼트만** 기본 스토리지에서 계층형 스토리지로 복사됨
- 복사 시, 해당 세그먼트의 **모든 메시지**가 계층형 스토리지로 이동
- **활성 세그먼트는 복사되지 않으며**, 닫힘 시점은 다음 설정에 따라 결정
  - `segment.bytes` (세그먼트 크기)
  - `segment.ms` (세그먼트 롤 시간)
  
### 보존 설정 규칙

- Kafka의 기본 보존 설정
  - `log.retention.ms`: 전체 보존 시간
  - `log.retention.bytes`: 전체 보존 크기
  - 클러스터 또는 토픽 단위로 설정 가능

- **계층형 스토리지 활성화 시**, 아래 설정을 추가로 사용 가능
  - `local.retention.ms`: 삭제하기 전에 로컬 로그 세그먼트를 보존할 시간
  - `local.retention.bytes`: 로컬 보존 크기

#### 예시

- `log.retention.ms = 7일`
- `local.retention.ms = 12시간`

→ 처음 12시간은 로컬 스토리지에 저장  
→ 이후 7일까지는 S3 기반 계층형 스토리지에 저장

- 일반적인 retention 설정(`log.retention.*`)은 **전체 로그(로컬 + 계층형)에 적용됨**
- Kafka는 데이터를 계층형으로 복사한 후에도, retention 조건이 만족되면 **해당 메시지를 계층형 스토리지에서도 삭제함**


| 시간 | 설명 |
|------|------|
| **T0** | 계층형 스토리지 비활성 상태. 토픽 파티션 0에 두 개의 세그먼트 존재, 그중 하나는 활성 상태 |
| **T1 (<2일)** | 계층형 스토리지 활성화됨. <br>닫힌 세그먼트 0은 계층형 스토리지로 복사되고, 로컬에도 유지됨. <br>세그먼트 1은 아직 활성 상태로 복사 대상 아님 |
| **T2 (2일 경과)** | `local.retention.ms = 2일` 설정에 따라 세그먼트 0은 **로컬에서 삭제**, 계층형 스토리지에만 존재 |
| **T3 (5일 경과)** | `retention.ms = 5일` 설정에 따라 세그먼트 0은 **계층형 스토리지에서도 삭제됨**. <br>세그먼트 1은 여전히 활성 상태이므로 복사 또는 삭제 대상 아님 |


### 요약

- 계층형 스토리지는 **닫힌 세그먼트만 복사**함
- 로컬과 계층형 스토리지에 **각각 retention 정책을 설정 가능**
- retention 기간이 끝나면 **계층형 스토리지에서도 메시지 삭제**
- 활성 세그먼트는 복사도, 삭제도 **대상 아님**

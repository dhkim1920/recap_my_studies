# 리눅스 패킷 필터링과 정책 적용

## iptables
- 리눅스 커널의 netfilter에 방화벽,포워딩,NAT 규칙을 설정하는 유저스페이스 도구다.
- 테이블,체인에 규칙을 순서대로 두고 패킷이 들어오면 위에서 아래로 순차 매칭한다.
- 대표 체인 예시: INPUT,OUTPUT,FORWARD(filter), PREROUTING,POSTROUTING(nat)
- 설정에 따라 iptables가 xtables(legacy)로 동작하기도 하고, nftables 커널 백엔드(nf_tables)로 변환되어 동작(iptables-nft)하기도 한다.

## nftables
- netfilter 규칙을 다루는 차세대 프레임워크와 도구
- iptables,ip6tables,ebtables,arptables,ipset 계열을 대체·통합하는 방향의 규칙 체계다.
- set,map 같은 자료구조를 써서 대량 규칙을 효율적으로 관리·매칭할 수 있다.
- 규칙 표현과 관리가 일관적이며 단일 도구로 IPv4,IPv6,브리지,ARP 계열을 다루는 구성이 가능하다.

## eBPF
- 방화벽 도구가 아니라 리눅스 커널에서 안전하게 실행되는 프로그램 런타임(가상 머신)이다.
- 네트워크 경로의 여러 지점에 프로그램을 붙여 패킷 처리와 관측을 수행한다.
- 대표 적용 지점은 XDP, TC, cgroup, socket 훅이다.
- 룰 나열이 아니라 코드로 로직을 구현할 수 있어 동적 정책, 고성능 필터링, 계측, 트레이싱에 쓰인다.
- 커널 버전,기능 호환성과 운영 복잡도가 올라갈 수 있다.

## 관계
- iptables와 nftables는 netfilter 기반의 “규칙형” 패킷 필터링, NAT 설정 방식이다.
- eBPF는 커널에 프로그램을 붙여 네트워크, 보안, 관측을 더 유연하게 구현하는 방식이다.

## 선택 기준(일반적)
- 단순 서버 방화벽, NAT이면 nftables 또는 기존 환경 유지 목적의 iptables를 쓴다.
- 규칙 수가 크고 관리성, 성능을 중시하면 nftables가 유리한 경우가 많다.
- 초저지연 L3,L4 드롭, 대규모 정책, 관측까지 통합하려면 eBPF(XDP,TC 등) 기반 접근을 쓴다.


```md
## 참고) eBPF 훅의 종류
- **XDP(eXpress Data Path)**: 네트워크 입력 경로의 매우 이른 지점에 붙는 eBPF 훅이다. 드라이버가 지원하면 **native XDP(드라이버 경로)** 로 붙고, 지원이 없으면 **generic XDP(커널 경로)** 로도 동작한다. 주요 동작은 드롭/패스/리다이렉트다.
- **TC(traffic control)**: 리눅스 트래픽 제어(qdisc) 경로에 붙는 eBPF 훅이다. 인터페이스 **ingress/egress**에서 패킷을 분류하고 필요하면 수정/드롭하며, shaping 같은 트래픽 제어와 함께 쓴다.
- **cgroup 훅**: cgroup(컨테이너, 프로세스 그룹) 단위로 **소켓 관련 동작**에 정책을 거는 eBPF 훅이다. 소켓 생성/연결/바인드/옵션 설정/주소 처리 같은 지점에서 허용·차단·계측을 한다(훅 타입에 따라 범위가 달라진다).
- **socket 훅**: 소켓 계층에 붙는 eBPF 훅이다. 소켓/연결 단위로 필터링, 트래픽 분류, 로드밸런싱 보조, 계측 등을 한다. 예시는 **socket filter**, **sockops**, **sk_msg**, **sk_skb**, **cgroup_sock / cgroup_sock_addr** 계열이다.
```
